<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="CalculateTemplatesVersion"
          DependsOnTargets="SetSdkVersionInfo">
    <PropertyGroup>
      <AspNetCore30VersionPreReleaseSeparator>$(AspNetCorePackageVersionFor30Templates.IndexOf('-'))</AspNetCore30VersionPreReleaseSeparator>
      <AspNetCore30VersionMajorMinorPatchVersion>$(AspNetCorePackageVersionFor30Templates)</AspNetCore30VersionMajorMinorPatchVersion>
      <AspNetCore30VersionMajorMinorPatchVersion Condition=" '$(AspNetCore30VersionPreReleaseSeparator)' != -1 ">$(AspNetCorePackageVersionFor30Templates.Substring(0, $(AspNetCore30VersionPreReleaseSeparator)))</AspNetCore30VersionMajorMinorPatchVersion>
      <BundledTemplates30Version>$(AspNetCore30VersionMajorMinorPatchVersion)</BundledTemplates30Version>
      <BundledTemplates30MSIVersion>$(AspNetCore30VersionMajorMinorPatchVersion).$(GitCommitCount)</BundledTemplates30MSIVersion>
      <BundledTemplates30Version Condition=" '$(DropSuffix)' != 'true' And '$(VersionSuffix)' != '' ">$(BundledTemplates30Version)-$(VersionSuffix)</BundledTemplates30Version>

      <AspNetCore22VersionPreReleaseSeparator>$(AspNetCorePackageVersionFor22Templates.IndexOf('-'))</AspNetCore22VersionPreReleaseSeparator>
      <AspNetCore22VersionMajorMinorPatchVersion>$(AspNetCorePackageVersionFor22Templates)</AspNetCore22VersionMajorMinorPatchVersion>
      <AspNetCore22VersionMajorMinorPatchVersion Condition=" '$(AspNetCore22VersionPreReleaseSeparator)' != -1 ">$(AspNetCorePackageVersionFor22Templates.Substring(0, $(AspNetCore22VersionPreReleaseSeparator)))</AspNetCore22VersionMajorMinorPatchVersion>
      <BundledTemplates22Version>$(AspNetCore22VersionMajorMinorPatchVersion)</BundledTemplates22Version>
      <BundledTemplates22MSIVersion>$(AspNetCore22VersionMajorMinorPatchVersion).$(GitCommitCount)</BundledTemplates22MSIVersion>
      <BundledTemplates22Version Condition=" '$(DropSuffix)' != 'true' And '$(VersionSuffix)' != '' ">$(BundledTemplates22Version)-$(VersionSuffix)</BundledTemplates22Version>

      <AspNetCore21VersionPreReleaseSeparator>$(AspNetCorePackageVersionFor21Templates.IndexOf('-'))</AspNetCore21VersionPreReleaseSeparator>
      <AspNetCore21VersionMajorMinorPatchVersion>$(AspNetCorePackageVersionFor21Templates)</AspNetCore21VersionMajorMinorPatchVersion>
      <AspNetCore21VersionMajorMinorPatchVersion Condition=" '$(AspNetCore21VersionPreReleaseSeparator)' != -1 ">$(AspNetCorePackageVersionFor21Templates.Substring(0, $(AspNetCore21VersionPreReleaseSeparator)))</AspNetCore21VersionMajorMinorPatchVersion>
      <BundledTemplates21Version>$(AspNetCore21VersionMajorMinorPatchVersion)</BundledTemplates21Version>
      <BundledTemplates21MSIVersion>$(AspNetCore21VersionMajorMinorPatchVersion).$(GitCommitCount)</BundledTemplates21MSIVersion>
      <BundledTemplates21Version Condition=" '$(DropSuffix)' != 'true' And '$(VersionSuffix)' != '' ">$(BundledTemplates21Version)-$(VersionSuffix)</BundledTemplates21Version>
    </PropertyGroup>
  </Target>

  <ItemGroup>
    <Bundled30Templates Include="Microsoft.DotNet.Common.ItemTemplates" Version="$(MicrosoftDotNetCommonItemTemplatesPackageVersion)" />
    <Bundled30Templates Include="Microsoft.DotNet.Common.ProjectTemplates.3.0" Version="$(MicrosoftDotNetCommonProjectTemplates30PackageVersion)" />
    <Bundled30Templates Include="Microsoft.DotNet.Test.ProjectTemplates.3.0" Version="$(MicrosoftDotNetTestProjectTemplates30PackageVersion)" />
    <Bundled30Templates Include="Microsoft.Dotnet.Wpf.ProjectTemplates" Version="$(MicrosoftDotnetWpfProjectTemplatesPackageVersion)" />
    <Bundled30Templates Include="Microsoft.Dotnet.WinForms.ProjectTemplates" Version="$(MicrosoftDotnetWinFormsProjectTemplatesPackageVersion)" />
    <Bundled30Templates Include="Microsoft.DotNet.Web.ItemTemplates" Version="$(AspNetCoreVersion)" />
    <Bundled30Templates Include="Microsoft.DotNet.Web.ProjectTemplates.3.0" Version="$(AspNetCoreVersion)" />
    <Bundled30Templates Include="Microsoft.DotNet.Web.Spa.ProjectTemplates.3.0" Version="$(AspNetCoreVersion)" />
    <Bundled30Templates Include="NUnit3.DotNetNew.Template" Version="$(NUnit3TemplatesVersion)" />
  </ItemGroup>

  <ItemGroup>
    <Bundled22Templates Include="Microsoft.DotNet.Common.ItemTemplates" Version="$(MicrosoftDotNetCommonItemTemplatesPackageVersion)" />
    <Bundled22Templates Include="Microsoft.DotNet.Common.ProjectTemplates.2.2" Version="$(MicrosoftDotNetCommonProjectTemplates22PackageVersion)" />
    <Bundled22Templates Include="Microsoft.DotNet.Test.ProjectTemplates.2.2" Version="$(MicrosoftDotNetTestProjectTemplates22PackageVersion)" />
    <Bundled22Templates Include="Microsoft.DotNet.Web.ItemTemplates" Version="$(AspNetCoreVersion)" />
    <Bundled22Templates Include="Microsoft.DotNet.Web.ProjectTemplates.2.2" Version="$(AspNetCoreVersion)" />
    <Bundled22Templates Include="Microsoft.DotNet.Web.Spa.ProjectTemplates" Version="$(AspNetCoreVersion)" />
    <Bundled22Templates Include="NUnit3.DotNetNew.Template" Version="$(NUnit3TemplatesVersion)" />
  </ItemGroup>

  <ItemGroup>
    <Bundled21Templates Include="Microsoft.DotNet.Common.ItemTemplates" Version="$(MicrosoftDotNetCommonItemTemplatesPackageVersion)" />
    <Bundled21Templates Include="Microsoft.DotNet.Common.ProjectTemplates.2.1" Version="$(MicrosoftDotNetCommonProjectTemplates20PackageVersion)" />
    <Bundled21Templates Include="Microsoft.DotNet.Test.ProjectTemplates.2.1" Version="$(MicrosoftDotNetTestProjectTemplates20PackageVersion)" />
    <Bundled21Templates Include="Microsoft.DotNet.Web.ItemTemplates" Version="$(AspNetCoreVersion)" />
    <Bundled21Templates Include="Microsoft.DotNet.Web.ProjectTemplates.2.1" Version="$(AspNetCoreVersion)" />
    <Bundled21Templates Include="Microsoft.DotNet.Web.Spa.ProjectTemplates" Version="$(AspNetCoreVersion)" />
    <Bundled21Templates Include="NUnit3.DotNetNew.Template" Version="$(NUnit3TemplatesVersion)" />
  </ItemGroup>
  
  <!-- Restore bundled templates via PackageReference -->
  <ItemGroup>
    <PackageReference Include="@(Bundled30Templates)" />
    <PackageReference Include="@(Bundled22Templates)" />
    <PackageReference Include="@(Bundled21Templates)" />
  </ItemGroup>

  <ItemGroup>
    <Bundled30Templates Update="@(Bundled30Templates)">
      <NupkgPathRelativeToPackageRoot>%(Identity)/%(Version)/%(Identity).%(Version).nupkg</NupkgPathRelativeToPackageRoot>
      <RestoredNupkgPath>$(NuGetPackageRoot)$([MSBuild]::ValueOrDefault('%(NupkgPathRelativeToPackageRoot)', '').ToLower())</RestoredNupkgPath>
    </Bundled30Templates>
  </ItemGroup>

  <ItemGroup>
    <Bundled22Templates Update="@(Bundled22Templates)">
      <NupkgPathRelativeToPackageRoot>%(Identity)/%(Version)/%(Identity).%(Version).nupkg</NupkgPathRelativeToPackageRoot>
      <RestoredNupkgPath>$(NuGetPackageRoot)$([MSBuild]::ValueOrDefault('%(NupkgPathRelativeToPackageRoot)', '').ToLower())</RestoredNupkgPath>
    </Bundled22Templates>
  </ItemGroup>
  
  <ItemGroup>
    <Bundled21Templates Update="@(Bundled21Templates)">
      <NupkgPathRelativeToPackageRoot>%(Identity)/%(Version)/%(Identity).%(Version).nupkg</NupkgPathRelativeToPackageRoot>
      <RestoredNupkgPath>$(NuGetPackageRoot)$([MSBuild]::ValueOrDefault('%(NupkgPathRelativeToPackageRoot)', '').ToLower())</RestoredNupkgPath>
    </Bundled21Templates>
  </ItemGroup>
  
  <Target Name="LayoutTemplates"
          DependsOnTargets="SetupBundledComponents;CalculateTemplatesVersion">
    <ItemGroup Condition="!$(ProductMonikerRid.StartsWith('win'))">
      <BundledTemplate Remove="Microsoft.Dotnet.Wpf.ProjectTemplates" />
      <BundledTemplate Remove="Microsoft.Dotnet.WinForms.ProjectTemplates" />
    </ItemGroup>
    <Copy SourceFiles="%(BundledTemplate.RestoredNupkgPath)"
          DestinationFolder="$(RedistLayoutPath)templates/$(BundledTemplates30Version)"/>
  </Target>

  <Target Name="LayoutTemplatesFor30MSI"
          DependsOnTargets="SetupBundledComponents;CalculateTemplatesVersion"
          Condition="$(ProductMonikerRid.StartsWith('win'))">
    <Copy SourceFiles="%(Bundled30Templates.RestoredNupkgPath)"
          DestinationFolder="$(Templates30LayoutPath)templates/$(BundledTemplates30Version)"/>
  </Target>

  <Target Name="LayoutTemplatesFor22MSI"
        DependsOnTargets="SetupBundledComponents;CalculateTemplatesVersion"
        Condition="$(ProductMonikerRid.StartsWith('win'))">
    <Copy SourceFiles="%(Bundled22Templates.RestoredNupkgPath)"
          DestinationFolder="$(Templates22LayoutPath)templates/$(BundledTemplates22Version)"/>
  </Target>

  <Target Name="LayoutTemplatesFor21MSI"
        DependsOnTargets="SetupBundledComponents;CalculateTemplatesVersion"
        Condition="$(ProductMonikerRid.StartsWith('win'))">
    <Copy SourceFiles="%(Bundled21Templates.RestoredNupkgPath)"
          DestinationFolder="$(Templates21LayoutPath)templates/$(BundledTemplates21Version)"/>
  </Target>
</Project>
