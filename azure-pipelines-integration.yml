# Branches that trigger a build on commit
trigger:
- main
- feature/*
- release/*

# Branches that trigger builds on PR
pr:
- main
- feature/*
- release/*

jobs:

- job: Format
  pool:
    vmImage: 'windows-latest'
  strategy:
    maxParallel: 8
    matrix:
      format:
        _repo: "https://github.com/dotnet/format"
        _repoName: "dotnet/format"
        _targetSolution: "format.sln"
        _branchName: "main"
        _sha: "1ec992c6038af9d42499d3ac88c3fd65d0c2f6ed"
      roslyn:
        _repo: "https://github.com/dotnet/roslyn"
        _repoName: "dotnet/roslyn"
        _targetSolution: "Compilers.sln"
        _branchName: "main"
        _sha: "a6a78dd64fc1eb466113ece272747a72d497aad7"

      # TODO: Re-enable when formatting issue are investigated.

      # sdk:
      #   _repo: "https://github.com/dotnet/sdk"
      #   _repoName: "dotnet/sdk"
      #   _targetSolution: "sdk.sln"
      #   _branchName: "main"
      #   _sha: "c7b5cc64c4b5e52e2d6c48998ecdcaac6275d423"
      project-system:
        _repo: "https://github.com/dotnet/project-system"
        _repoName: "dotnet/project-system"
        _targetSolution: "ProjectSystem.sln"
        _branchName: "main"
        _sha: "51bab75c24acab0e243530fd3b48fd747d6a6cca"
      # msbuild:
      #   _repo: "https://github.com/dotnet/msbuild"
      #   _repoName: "dotnet/msbuild"
      #   _targetSolution: "MSBuild.sln"
      #   _branchName: "main"
      #   _sha: "14c24b2d38abe2662bd5e3bcc88c91a13655b073"

      # TODO: Re-enable when issue with submodule cloning is fixed.

      # aspnetcore:
      #   _repo: "https://github.com/dotnet/aspnetcore"
      #   _repoName: "dotnet/aspnetcore"
      #   _targetSolution: "AspNetCore.sln"
      #   _branchName: "main"
      #   _sha: "03e670f9854651b9995d57f8e87cef16022e739a"

      # TODO: efcore's SDK version is ahead of the rest of the stack.
      #       Re-enable the check when format is on the same version.

      # efcore:
      #   _repo: "https://github.com/dotnet/efcore"
      #   _repoName: "dotnet/efcore"
      #   _targetSolution: "All.sln"
      #   _branchName: "main"
      #   _sha: "0adaa621143969416ccd8f999aaea5e99489a11c"
      razor-tooling:
        _repo: "https://github.com/dotnet/razor-tooling"
        _repoName: "dotnet/razor-tooling"
        _targetSolution: "Razor.sln"
        _branchName: "main"
        _sha: "4256307904b7b6fc95326901259d19481bcc3b8e"
  timeoutInMinutes: 60
  steps:
    - script: eng\integration-test.cmd -repo '$(_repo)' -branchName '$(_branchName)' -sha '$(_sha)' -targetSolution '$(_targetSolution)' -testPath '$(Agent.TempDirectory)\temp' -stage 'prepare'
      displayName: Prepare $(_repoName) for formatting

    - script: eng\integration-test.cmd -repo '$(_repo)' -branchName '$(_branchName)' -sha '$(_sha)' -targetSolution '$(_targetSolution)' -testPath '$(Agent.TempDirectory)\temp' -stage 'format-workspace'
      displayName: Run dotnet-format on $(_repoName) $(_targetSolution)

    - script: eng\integration-test.cmd -repo '$(_repo)' -branchName '$(_branchName)' -sha '$(_sha)' -targetSolution '$(_targetSolution)' -testPath '$(Agent.TempDirectory)\temp' -stage 'format-folder'
      displayName: Run dotnet-format on $(_repoName) repo folder
